Development Guide
=================

This document is a guide for developers who want to contribute to the project.

Environment setup
-----------------

Clone the repository
^^^^^^^^^^^^^^^^^^^^

.. code-block:: console

    git clone git@github.com:newton-physics/newton.git
    cd newton

Using uv
^^^^^^^^

`uv <https://docs.astral.sh/uv/>`_ is a Python package and project manager.

Install uv:

.. code-block:: console

    # On macOS and Linux.
    curl -LsSf https://astral.sh/uv/install.sh | sh

    # On Windows.
    powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"

Run basic examples:

.. code-block:: console

    # An example with basic dependencies
    uv run newton/examples/example_quadruped.py

    # An example that requires extras
    uv run --all-extras newton/examples/example_humanoid.py

Updating all dependencies in the project `lockfile <https://docs.astral.sh/uv/concepts/projects/layout/#the-lockfile>`__,
remember to commit ``uv.lock`` after running:

.. code-block:: console

    uv lock -U

Using venv
^^^^^^^^^^

These instructions are meant for users who wish to set up a development environment using `venv <https://docs.python.org/3/library/venv.html>`__
or Conda (e.g. from `Miniforge <https://github.com/conda-forge/miniforge>`__).

.. code-block:: console

    python -m venv .venv

    # On macOS and Linux.
    source .venv/bin/activate
    
    # On Windows (console).
    .venv\Scripts\activate.bat

    # On Windows (PowerShell).
    .venv\Scripts\Activate.ps1

Installing dependencies including optional ones:

.. code-block:: console

    python -m pip install mujoco --pre -f https://py.mujoco.org/
    python -m pip install warp-lang --pre -U -f https://pypi.nvidia.com/warp-lang/
    python -m pip install git+https://github.com/google-deepmind/mujoco_warp.git@main
    python -m pip install -e .[dev]

Run basic examples:

.. code-block:: console

    # An example with basic dependencies
    python newton/examples/example_quadruped.py

    # An example that requires extras
    python newton/examples/example_humanoid.py

Running the tests
-----------------

The Newton test suite can be run with ``uv run -m newton.tests`` or ``python -m newton.tests``.
By default, the test suite execution will be parallelized on up to eight processes.
Pass the ``--help`` flag to see the available options for the test runner.

Some tests use optional dependencies like `usd-core <https://pypi.org/project/usd-core/>`__ and
will be skipped if they are not installed.

When using uv, the test suite can be run with all extras installed by running:

.. code-block:: console

    uv run --all-extras -m newton.tests

When using venv, the extras for the test suite can be installed by running ``python -m pip install -e .[dev]``
from the root of the repository.

A code coverage report requires installing ``coverage[toml]`` and can be generated by appending the
``--coverage --coverage-html`` flags to the test command, e.g.

.. code-block:: console

    uv run --all-extras -m newton.tests --coverage --coverage-html htmlcov

The file ``htmlcov/index.html`` can be opened with a web browser to view the coverage report.

Code formatting and linting
---------------------------

`Ruff <https://docs.astral.sh/ruff/>`_ is used for Python linting and code formatting.
`pre-commit <https://pre-commit.com/>`_ can be used to ensure that local code complies with Newton's checks.
From the top of the repository, run:

.. code-block:: console

    # With uv installed
    uvx pre-commit run -a

    # With venv
    python -m pip install pre-commit
    pre-commit run -a

To automatically run pre-commit hooks with ``git commit``:

.. code-block:: console

    # With uv installed
    uvx pre-commit install

    # With venv
    pre-commit install

The hooks can be uninstalled with ``pre-commit uninstall``.

Building the documentation
--------------------------

Here are a few ways to build the documentation.

Using uv
^^^^^^^^

.. code-block:: console

    rm -rf docs/_build
    uv run --extra docs sphinx-build -W -b html docs docs/_build/html

    # Alternatively using the Makefile
    uv sync --extra docs
    source .venv/bin/activate
    cd docs
    make clean
    make html

Using venv
^^^^^^^^^^

.. code-block:: console

    python -m pip install -e .[docs]
    python -m sphinx -W -b html docs docs/_build/html

    # Alternatively using the Makefile
    cd docs
    make clean
    make html

Testing documentation code snippets
-----------------------------------

The ``doctest`` Sphinx builder is used to ensure that code snippets in the documentation remains up-to-date.

The doctests can be run with:

.. code-block:: console

    # With uv installed
    uv run --extra docs sphinx-build -W -b doctest docs docs/_build/doctest

    # With venv
    python -m sphinx -W -b doctest docs docs/_build/doctest

For more information, see the `sphinx.ext.doctest <https://www.sphinx-doc.org/en/master/usage/extensions/doctest.html>`__
documentation.

Packaging
---------

To build a ``.whl`` file (e.g. to test the creation of a
`distribution package <https://packaging.python.org/en/latest/glossary/#term-Distribution-Package>`__), run:

.. code-block:: console

    uv build --wheel

The output will be placed in the ``dist/`` subdirectory.
